<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Usuario</title>
    <!-- Incluye Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e2e8f0; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Crear Cuenta</h1>
        
        <form id="registration-form" method="POST">
            
            <!-- Campo Email -->
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                <input type="email" id="email" name="email" required 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                       placeholder="tu.correo@ejemplo.com">
            </div>

            <!-- Campo Username -->
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Nombre de Usuario</label>
                <input type="text" id="username" name="username" required 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                       placeholder="ej: usuario_monitor">
            </div>

            <!-- Campo Contraseña -->
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                <input type="password" id="password" name="password" required 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                       placeholder="Mínimo 8 caracteres">
            </div>

            <!-- Botón de Envío -->
            <button type="submit" 
                    class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                Registrarse y Enviar OTP
            </button>
        </form>
        
        <p class="text-center text-sm text-gray-600 mt-6">
            ¿Ya tienes una cuenta? 
            <a th:href="@{/login}" class="text-blue-600 hover:text-blue-800 font-medium">Inicia Sesión aquí</a>
        </p>
        
        <!-- Mensajes de Feedback (Usados por JavaScript) -->
        <div id="message-area" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
    </div>

    <!-- SCRIPT PARA MANEJAR EL ENVÍO DEL FORMULARIO Y LA VERIFICACIÓN DE OTP -->
    <script>
        document.getElementById('registration-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = event.target;
            const messageArea = document.getElementById('message-area');
            messageArea.classList.add('hidden');
            messageArea.innerHTML = '';

            const userData = {
                email: form.email.value,
                username: form.username.value,
                password: form.password.value
            };

            // 1. Envía los datos de registro
            try {
                const response = await fetch('/api/sensores/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const message = await response.text();

                if (response.ok) {
                    showMessage('success', message + ". Por favor, ingresa el código OTP que recibiste.");
                    // Muestra el formulario para ingresar el código OTP
                    showOtpForm(userData.email);
                } else {
                    showMessage('error', "Error: " + message);
                }
            } catch (error) {
                showMessage('error', "No se pudo conectar con el servidor.");
            }
        });

        function showMessage(type, message) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = message;
            messageArea.classList.remove('hidden', 'bg-red-100', 'bg-green-100');
            messageArea.classList.add(type === 'success' ? 'bg-green-100' : 'bg-red-100');
            messageArea.classList.add(type === 'success' ? 'text-green-800' : 'text-red-800');
        }

        function showOtpForm(email) {
            const formContainer = document.getElementById('registration-form').parentElement;
            
            // Reemplaza el formulario de registro con el formulario de OTP
            formContainer.innerHTML = `
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Verificación de Cuenta</h1>
                <p class="text-center text-gray-600 mb-4">Ingresa el código de 6 dígitos enviado a <strong>${email}</strong>.</p>

                <form id="otp-form" class="mt-4">
                    <div class="mb-6">
                        <label for="otp" class="block text-sm font-medium text-gray-700 mb-1">Código OTP</label>
                        <input type="text" id="otp" name="otp" required maxlength="6"
                               class="w-full px-4 py-2 text-center text-2xl border-2 border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="123456">
                    </div>
                    
                    <input type="hidden" id="otp-email" value="${email}">
                    
                    <button type="submit" 
                            class="w-full bg-green-600 text-white font-bold py-2.5 rounded-lg hover:bg-green-700 transition duration-150 shadow-md">
                        Verificar Código
                    </button>
                </form>

                <div id="otp-message-area" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
            `;
            
            // Asigna el listener al nuevo formulario
            document.getElementById('otp-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const otpForm = e.target;
                const otpMessageArea = document.getElementById('otp-message-area');
                otpMessageArea.classList.add('hidden');
                otpMessageArea.innerHTML = '';
                
                const enteredOtp = otpForm.otp.value;
                const userEmail = otpForm['otp-email'].value;

                // 2. Envía el código OTP para verificación
                try {
                    // FIX: Se corrigió el uso incorrecto de template literals (se eliminaron los escapes con \)
                    const verifyResponse = await fetch(`/api/sensores/verify?email=${userEmail}&otp=${enteredOtp}`, {
                        method: 'POST'
                    });

                    const verifyMessage = await verifyResponse.text();
                    
                    if (verifyResponse.ok) {
                        // Verificación exitosa
                        otpMessageArea.innerHTML = verifyMessage + ". Serás redirigido al inicio de sesión.";
                        otpMessageArea.classList.remove('hidden', 'bg-red-100');
                        otpMessageArea.classList.add('bg-green-100', 'text-green-800');
                        
                        // Redirigir al login después de 3 segundos
                        setTimeout(() => {
                            window.location.href = '/login'; 
                        }, 3000);

                    } else {
                        // Error en el código OTP
                        otpMessageArea.innerHTML = "Error: " + verifyMessage;
                        otpMessageArea.classList.remove('hidden', 'bg-green-100');
                        otpMessageArea.classList.add('bg-red-100', 'text-red-800');
                    }
                } catch (error) {
                    otpMessageArea.innerHTML = "No se pudo conectar con el servidor de verificación.";
                    otpMessageArea.classList.remove('hidden', 'bg-green-100');
                    otpMessageArea.classList.add('bg-red-100', 'text-red-800');
                }
            });

            document.getElementById('message-area').classList.add('hidden');
        }
    </script>
</body>
</html>